<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reaction Game with Analytics</title>
  <style>
    body { font-family: Arial; text-align:center; background:#121212; color:white; margin:0; padding:0; }
    h1,h2 { margin-top:20px; }
    .controls { margin:20px 0; }
    .game-button { padding:20px 40px; margin:20px; font-size:20px; border:none; border-radius:12px; cursor:pointer; background:#333; color:white; transition: box-shadow 0.3s, background 0.3s, transform 0.2s; }
    .game-button.glow { background:#2ecc71; box-shadow:0 0 20px #2ecc71,0 0 40px #2ecc71; transform:scale(1.1); }
    .status { margin-top:20px; font-size:20px; }
    .countdown { margin:20px 0; font-size:24px; color:#f1c40f; }
    .results { margin-top:20px; font-size:18px; }
    table { margin:20px auto; border-collapse:collapse; width:60%; }
    th, td { border:1px solid #444; padding:8px; font-size:16px; }
    th { background:#333; }
    td { background:#222; }
    #round-counter { margin-top:10px; font-size:20px; color:#f39c12; }
    canvas.confetti { position:fixed; top:0; left:0; pointer-events:none; width:100%; height:100%; z-index:9999; }

    /* Metrics panel */
    #metrics { margin:20px; font-size:18px; text-align:left; max-width:400px; margin:auto; }
  </style>
</head>
<body>
  <h1>Reaction Game</h1>

  <!-- Mode and Difficulty -->
  <div class="controls">
    <label for="mode">Game Mode:</label>
    <select id="mode">
      <option value="classic">Classic</option>
      <option value="unlimited">Unlimited</option>
      <option value="endurance">Endurance</option>
    </select>

    <label for="difficulty">Difficulty:</label>
    <select id="difficulty">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>

    <button onclick="startGame()">Start Game</button>
  </div>

  <!-- Aggregated Metrics -->
  <div id="metrics">
    <div>Average Reaction Time: <span id="avg-time">-</span> ms</div>
    <div>Correct Presses: <span id="correct-count">0</span></div>
    <div>Wrong Presses: <span id="wrong-count">0</span></div>
    <div>Highscore: <span id="highscore">-</span> ms</div>
  </div>

  <!-- Countdown Timer -->
  <div class="countdown" id="countdown">Countdown: 0</div>
  <div id="round-counter">Round 0</div>

  <!-- Game Buttons -->
  <div>
    <button class="game-button" id="button1" onclick="handleButtonPress(1)">Button 1</button>
    <button class="game-button" id="button2" onclick="handleButtonPress(2)">Button 2</button>
    <button class="game-button" id="button3" onclick="handleButtonPress(3)">Button 3</button>
  </div>

  <!-- Status + Results -->
  <div class="status" id="status">Press Start to Play</div>
  <div class="results" id="results"></div>

  <table id="attempts-table">
    <thead>
      <tr>
        <th>Round</th>
        <th>Reaction Time (ms)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Analytics Chart -->
  <h2>Analytics</h2>
  <canvas id="reactionChart" width="600" height="300"></canvas>

  <!-- Confetti Canvas -->
  <canvas class="confetti" id="confetti-canvas"></canvas>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Main JS -->
  <script>
    // ===== Game State =====
    let gameMode = "classic";
    let difficulty = "easy";
    let targetButton = null;
    let startTime = null;
    let round = 0;
    let maxRounds = 5;
    let highScore = Infinity;
    let sessionResults = [];

    // ===== Difficulty Settings =====
    const difficultySettings = {
      easy: { minDelay:2000, maxDelay:4000 },
      medium: { minDelay:1000, maxDelay:3000 },
      hard: { minDelay:500, maxDelay:2000 }
    };

    // ===== Chart =====
    let reactionChart = null;
    function initChart() {
      const ctx = document.getElementById('reactionChart').getContext('2d');
      reactionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Reaction Time (ms)',
              data: [],
              borderColor: '#2ecc71',
              backgroundColor: 'rgba(46, 204, 113, 0.2)',
              tension: 0.2,
              fill: true
            }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero:true } } }
      });
    }

    function updateChart() {
      if(!reactionChart) return;
      const times = sessionResults.map(r=>r.reactionTime==="-"?null:r.reactionTime);
      reactionChart.data.labels = sessionResults.map(r=>`R${r.round}`);
      reactionChart.data.datasets[0].data = times;
      reactionChart.update();
    }

    // ===== Metrics Update =====
    function updateMetrics(){
      const validTimes = sessionResults.filter(r=>r.reactionTime!=="-").map(r=>r.reactionTime);
      const avg = validTimes.length ? (validTimes.reduce((a,b)=>a+b,0)/validTimes.length).toFixed(2) : "-";
      const correct = sessionResults.filter(r=>r.status==="Correct").length;
      const wrong = sessionResults.filter(r=>r.status==="Wrong").length;
      document.getElementById("avg-time").textContent = avg;
      document.getElementById("correct-count").textContent = correct;
      document.getElementById("wrong-count").textContent = wrong;
      document.getElementById("highscore").textContent = highScore===Infinity?"-":highScore;
    }

    // ===== Start Game =====
    function startGame(){
      gameMode = document.getElementById("mode").value;
      difficulty = document.getElementById("difficulty").value;
      round = 0;
      targetButton = null;
      sessionResults = sessionResults.slice(-20);
      document.querySelector("#attempts-table tbody").innerHTML = "";
      document.getElementById("results").innerHTML = "";
      document.getElementById("status").textContent = "Game started!";
      updateRoundCounter();
      nextRound();
    }

    // ===== Next Round =====
    function nextRound(){
      clearGlow();
      round++;
      updateRoundCounter();
      if((gameMode==="classic"||gameMode==="endurance") && round>maxRounds){
        endGame();
        return;
      }
      if (gameMode === "endurance" && round > maxRounds) {
        endEndurance();
        return;
      }

      document.getElementById("status").textContent = "Get ready...";
      const {minDelay,maxDelay} = difficultySettings[difficulty];
      const delay = Math.floor(Math.random()*(maxDelay-minDelay+1))+minDelay;

      setTimeout(()=>{
        targetButton = Math.floor(Math.random()*3)+1;
        document.getElementById(`button${targetButton}`).classList.add("glow");
        document.getElementById("status").textContent = `Press Button ${targetButton}! (or press ${targetButton})`;
        startTime = Date.now();
      }, delay);
    }

    // ===== Handle Button Press =====
    function handleButtonPress(button){
      if(!targetButton) return;
      let reactionTime = Date.now() - startTime;
      let statusText="";
      if(button===targetButton){
        statusText = `✅ Correct! Time: ${reactionTime} ms`;
        sessionResults.push({round,reactionTime,status:"Correct"});
        if(reactionTime<highScore){
          highScore = reactionTime;
          confetti({particleCount:100, spread:70, origin:{y:0.6}});
        }
      } else {
        statusText = `❌ Wrong! Pressed ${button}, needed ${targetButton}`;
        sessionResults.push({round,reactionTime:"-",status:"Wrong"});
      }
      document.getElementById("status").textContent = statusText;
      updateAttemptsTable();
      updateChart();
      updateMetrics();
      clearGlow();
      targetButton = null;
      setTimeout(nextRound, gameMode==="unlimited"?1000:1500);
    }

    // ===== Round Counter =====
    function updateRoundCounter(){
      document.getElementById("round-counter").textContent = `Round ${round} of ${maxRounds}`;
    }

    // ===== Update Attempts Table =====
    function updateAttemptsTable(){
      const tbody = document.querySelector("#attempts-table tbody");
      tbody.innerHTML="";
      sessionResults.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.round}</td><td>${r.reactionTime}</td><td>${r.status}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== Clear Glow =====
    function clearGlow(){
      document.querySelectorAll(".game-button").forEach(btn=>btn.classList.remove("glow"));
    }

    // ===== End Game =====
    function endGame(){
      let times = sessionResults.filter(r=>r.reactionTime!=="-").map(r=>r.reactionTime);
      const avg = times.length ? (times.reduce((a,b)=>a+b,0)/times.length).toFixed(2) : "-";
      document.getElementById("status").textContent = `Game Over! Average: ${avg} ms`;
    }

    // ===== Keyboard Input =====
    document.addEventListener("keydown",(e)=>{
      if(["1","2","3"].includes(e.key)){
        handleButtonPress(parseInt(e.key));
      }
    });

    // ===== Initialize =====
    window.addEventListener("DOMContentLoaded",()=>{
      initChart();
    });
  </script>
</body>
</html>

